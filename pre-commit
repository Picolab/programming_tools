#!/usr/bin/perl -w
#
#
# To enable this hook, copy to "pre-commit" in the repo's git dir and make it executable.
#
# You will need to change $PARSER to the path that you've installed the Kynetx parser. 
#



my $against;
if (`git rev-parse --verify HEAD`) {
$against="HEAD";
} else {
# Initial commit: diff against an empty tree object
$against="4b825dc642cb6eb9a060e54bf8d69288fbee4904";
}

# install using
# npm install -g krl-compiler
my $PARSER="krl-compiler";

my $allownoparse=`git config hooks.allownoparse`;
#print $allownoparse;

my $parse_error = 0;

# Cross platform projects tend to avoid non-ascii filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if (! defined $allownoparse || length($allownoparse) == 0) {

    my $file_list = `git diff --name-only --diff-filter=ACM $against`;
    my ($parse_result, $file, @parse_lines);
    foreach $f (split(/\n/, $file_list)) {
      next unless $f =~ m/\.krl$/;
      $file = $f;
      $parse_result = `cat $f | $PARSER 2>&1 >/dev/null`;
      #	print "$f: Parser says $parse_result";
      if ($?) {
        $parse_error = 1; @parse_lines = split('\n',$parse_result);
        last
      }
    }

    if ($parse_error) {
	die "Parse errors in $file:\n\n$parse_lines[4]\n$parse_lines[5]\n$parse_lines[6]\n$parse_lines[7]\n$parse_lines[8]\n\nYou can disable checking by setting the hook.allownoparse to true\n";
    }
}
